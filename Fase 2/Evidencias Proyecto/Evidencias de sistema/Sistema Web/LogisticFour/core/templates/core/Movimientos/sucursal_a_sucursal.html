{% extends "core/base.html" %}
{% load static %}
{% block title %}Movimiento: Sucursal â†’ Sucursal{% endblock %}

{% block content %}
<style>
  :root {
    --ink: #0f172a;
    --muted: #64748b;
    --line: #e2e8f0;
    --bg: #f1f5f9;
    --card: #ffffff;
    --accent: #111827;
    --success-bg: #ecfdf5;
    --success-border: #a7f3d0;
    --success-ink: #166534;
    --error-bg: #fef2f2;
    --error-border: #fecaca;
    --error-ink: #991b1b;
  }

  .mv-shell {
    max-width: 1080px;
    margin-inline: auto;
    display: grid;
    gap: 1.1rem;
    padding: 0 0 1.1rem;
  }

  .mv-head {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    align-items: center;
  }

  .mv-title {
    font-weight: 800;
    font-size: clamp(1.35rem, 2.4vw, 1.6rem);
    margin: 0;
    display: flex;
    gap: .6rem;
    align-items: center;
  }

  .mv-title-badge {
    background: #e2e8f0;
    color: #0f172a;
    border-radius: 999px;
    padding: 3px 10px 4px;
    font-size: .68rem;
    text-transform: uppercase;
    letter-spacing: .04em;
  }

  .mv-sub {
    margin: .2rem 0 0;
    color: var(--muted);
    font-size: .85rem;
  }

  .mv-formwrap {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1.05fr .95fr;
    align-items: flex-start;
  }

  .mv-card {
    background: var(--card);
    border: 1px solid rgba(148,163,184,.35);
    border-radius: 14px;
    box-shadow: 0 12px 35px rgba(15,23,42,.03);
    animation: fadeUp .35s ease;
  }

  .mv-card-body {
    padding: 16px 16px 10px;
    display: grid;
    gap: 14px;
  }

  .mv-form {
    display: grid;
    gap: 13px;
  }

  .mv-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .mv-label {
    font-weight: 600;
    color: var(--ink);
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .mv-step-pill {
    background: rgba(15,23,42,.05);
    border-radius: 999px;
    font-size: .65rem;
    padding: 2px 7px 3px;
  }

  .mv-select,
  .mv-input {
    width: 100%;
    padding: 9px 10px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    background: #f8fafc;
    outline: none;
    transition: box-shadow .15s ease, border .15s ease, background .15s ease;
    font-size: .9rem;
  }

  .mv-select:focus,
  .mv-input:focus {
    border-color: rgba(17,24,39,.55);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(15,23,42,.08);
  }

  .mv-select[disabled],
  .mv-input[disabled] {
    background: #e2e8f0;
    cursor: not-allowed;
    opacity: .85;
  }

  .mv-btnrow {
    display: flex;
    gap: .65rem;
    flex-wrap: wrap;
  }

  .mv-btn-primary {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 9.5px 16px 9px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    transition: transform .12s ease, box-shadow .12s ease;
  }

  .mv-btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 22px rgba(15,23,42,.14);
  }

  .mv-btn-secondary {
    background: transparent;
    border: 1px solid rgba(15,23,42,.15);
    border-radius: 999px;
    padding: 9px 14px 8px;
    font-weight: 500;
    color: #0f172a;
    text-decoration: none;
  }

  .mv-messages {
    display: grid;
    gap: 8px;
  }

  .msg-success,
  .msg-error {
    border-radius: .8rem;
    padding: 9px 11px;
    display: flex;
    gap: .7rem;
    align-items: flex-start;
  }

  .msg-success {
    background: var(--success-bg);
    border: 1px solid var(--success-border);
    color: var(--success-ink);
  }

  .msg-error {
    background: var(--error-bg);
    border: 1px solid var(--error-border);
    color: var(--error-ink);
  }

  .msg-icon {
    width: 26px;
    height: 26px;
    background: rgba(255,255,255,.75);
    border-radius: 999px;
    display: grid;
    place-items: center;
    font-weight: 700;
  }

  /* BotÃ³n "Ver guÃ­a de despacho" */
  .mv-btn-ghost {
    background: #ffffff;
    border-radius: 999px;
    border: 1px solid rgba(22, 163, 74, .4);
    padding: 6px 14px;
    font-size: .82rem;
    font-weight: 600;
    color: var(--success-ink);
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    text-decoration: none;
  }

  .mv-btn-ghost:hover {
    background: #f0fdf4;
  }

  /* SIDE */
  .mv-side-head {
    padding: 14px 16px 0;
    display: flex;
    justify-content: space-between;
    gap: .5rem;
  }

  .mv-side-title {
    font-weight: 600;
  }

  .mv-side-content {
    padding: 14px 16px 15px;
    display: grid;
    gap: .7rem;
  }

  .mv-badge {
    background: rgba(148,163,184,.12);
    border: 1px solid rgba(148,163,184,.35);
    border-radius: .7rem;
    padding: 4px 9px 4px;
    font-size: .72rem;
    display: inline-flex;
    gap: .4rem;
    align-items: center;
  }

  .mv-metric {
    background: #f8fafc;
    border: 1px solid rgba(148,163,184,.16);
    border-radius: .9rem;
    padding: 8px 9px 7px;
  }

  .mv-metric small {
    color: var(--muted);
    font-size: .7rem;
  }

  .mv-metric strong {
    font-size: 1.3rem;
    display: block;
  }

  .mv-empty {
    border: 1px dashed rgba(148,163,184,.5);
    border-radius: .9rem;
    padding: .55rem .7rem;
    font-size: .8rem;
    background: rgba(241,245,249,.3);
  }

  /* ==== Chips de producto (validado vs stock total) ==== */
  .mv-product-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
    font-size: .78rem;
    transition: opacity .15s ease;
  }

  .mv-product-meta.is-empty {
    opacity: .6;
  }

  .mv-chip {
    border-radius: 999px;
    padding: 3px 9px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .mv-chip-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: currentColor;
  }

  .mv-chip-valid {
    background: #dcfce7;
    color: #166534;
  }

  .mv-chip-stock {
    background: #e0f2fe;
    color: #075985;
  }

  /* Cantidad: ancho fijo en desktop, full en mÃ³vil */
  .mv-field--cantidad {
    max-width: 190px;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(5px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ====== RESPONSIVE ====== */

  @media (max-width: 960px) {
    .mv-formwrap {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 720px) {
    .mv-shell {
      padding-inline: 10px;
      gap: 1.25rem;
    }

    .mv-head {
      flex-direction: column;
      align-items: flex-start;
      gap: .4rem;
    }

    .mv-card-body,
    .mv-side-content {
      padding-inline: 12px;
    }

    .mv-title {
      font-size: 1.3rem;
      flex-wrap: wrap;
      gap: .4rem;
    }

    .mv-sub {
      font-size: .8rem;
    }

    .mv-form {
      gap: 1rem;
    }

    .mv-field--cantidad {
      max-width: 100%;
    }

    .mv-btnrow {
      flex-direction: column;
      align-items: stretch;
    }

    .mv-btn-primary,
    .mv-btn-secondary {
      width: 100%;
      justify-content: center;
      text-align: center;
    }
  }

  @media (max-width: 480px) {
    .mv-card-body,
    .mv-side-content {
      padding-block: 12px;
    }

    .mv-title-badge {
      font-size: .62rem;
    }

    .mv-metric strong {
      font-size: 1.1rem;
    }
  }
</style>

<div class="mv-shell">

  <!-- Encabezado -->
  <div class="mv-head">
    <div>
      <h1 class="mv-title">
        <span>Movimiento: Sucursal â†’ Sucursal</span>
        <span class="mv-title-badge">Inventario</span>
      </h1>
      <p class="mv-sub">
        Mueve stock entre sucursales. Selecciona la sucursal origen para cargar productos y destinos vÃ¡lidos.
      </p>
    </div>
  </div>

  <div class="mv-formwrap">

    <!-- FORM PRINCIPAL -->
    <div class="mv-card">
      <div class="mv-card-body">

        <form method="post" class="mv-form">
          {% csrf_token %}

          <!-- ORIGEN -->
          <div class="mv-field">
            <label class="mv-label">
              <span class="mv-step-pill">1</span> Sucursal origen
            </label>
            <select name="sucursal_origen" class="mv-select" required onchange="this.form.submit()">
              <option value="">â€” Seleccione sucursal origen â€”</option>
              {% for s in sucursales %}
                <option value="{{ s.id }}" {% if s.id|stringformat:'s' == sucursal_sel|stringformat:'s' %}selected{% endif %}>
                  {{ s.nombre }}
                </option>
              {% endfor %}
            </select>
            <small class="text-muted">De aquÃ­ se descontarÃ¡ el stock.</small>
          </div>

          <!-- DESTINO -->
          <div class="mv-field">
            <label class="mv-label">
              <span class="mv-step-pill">2</span> Sucursal destino
            </label>
            {% if sucursales_destino %}
              <select name="sucursal_destino" class="mv-select" required>
                <option value="">â€” Seleccione sucursal destino â€”</option>
                {% for s in sucursales_destino %}
                  <option value="{{ s.id }}">{{ s.nombre }}</option>
                {% endfor %}
              </select>
            {% else %}
              <select class="mv-select" disabled>
                <option>Seleccione una sucursal de origenâ€¦</option>
              </select>
            {% endif %}
            <small class="text-muted">AquÃ­ se sumarÃ¡ el stock.</small>
          </div>

          <!-- PRODUCTO -->
          <div class="mv-field">
            <label class="mv-label">
              <span class="mv-step-pill">3</span> Producto
            </label>
            {% if productos %}
              <select name="producto" id="productoSelect" class="mv-select" required>
                <option value="">â€” Seleccione producto â€”</option>
                {% for p in productos %}
                  <option
                    value="{{ p.id }}"
                    data-validado="{{ p.stock_validado|floatformat:0 }}"
                    data-stock="{{ p.stock_total|floatformat:0 }}"
                  >
                    {{ p.sku }} â€” {{ p.nombre }}
                    â€” âœ… {{ p.stock_validado|floatformat:0 }} val. Â· ðŸ“¦ {{ p.stock_total|floatformat:0 }} disp.
                  </option>
                {% endfor %}
              </select>
              <small class="text-muted">
                Solo se muestran productos con stock <strong>validado</strong> en la sucursal origen.
              </small>
            {% else %}
              <select class="mv-select" id="productoSelect" disabled>
                <option>Seleccione una sucursal de origenâ€¦</option>
              </select>
              <small class="text-muted">Selecciona primero la sucursal origen.</small>
            {% endif %}

            <!-- Chips de colores bajo el select -->
            <div class="mv-product-meta is-empty" id="productoMeta" aria-live="polite">
              <span class="mv-chip mv-chip-valid">
                <span class="mv-chip-dot"></span>
                Validado: <span id="metaValidado">â€”</span>
              </span>
              <span class="mv-chip mv-chip-stock">
                <span class="mv-chip-dot"></span>
                Stock total: <span id="metaStock">â€”</span>
              </span>
            </div>
          </div>

          <!-- CANTIDAD -->
          <div class="mv-field mv-field--cantidad">
            <label class="mv-label">
              <span class="mv-step-pill">4</span> Cantidad
            </label>
            <input type="number" name="cantidad" class="mv-input" min="1" value="1" required>
          </div>

          <!-- BOTONES -->
          <div class="mv-btnrow">
            <button type="submit" class="mv-btn-primary">
              <span style="font-size:1.1rem;">â‡„</span> Mover ahora
            </button>

            <a href="{% url 'mov_sucursal_a_sucursal' %}" class="mv-btn-secondary">
              Limpiar
            </a>
          </div>

          <!-- MENSAJES -->
          <div class="mv-messages">

            {% if success %}
              <div class="msg-success">
                <span class="msg-icon">âœ“</span>
                <div>
                  <div>{{ success }}</div>

                  {% if transferencia_id %}
                    <div style="margin-top:6px;">
                      <a href="{% url 'detalle_transferencia' transferencia_id %}"
                         class="mv-btn-ghost">
                        Ver guÃ­a de despacho
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if error %}
              <div class="msg-error">
                <span class="msg-icon">!</span>
                <div>{{ error }}</div>
              </div>
            {% endif %}

          </div>

        </form>

      </div>
    </div>

    <!-- PANEL LATERAL -->
    <div class="mv-card">
      <div class="mv-side-head">
        <div>
          <p class="mv-side-title">Resumen rÃ¡pido</p>
          <p class="mv-sub" style="margin-top:2px;">Estado actual del formulario.</p>
        </div>
      </div>

      <div class="mv-side-content">

        {% if sucursal_sel %}
          <span class="mv-badge">
            <span style="width:7px;height:7px;border-radius:999px;background:#22c55e;display:inline-block;"></span>
            Origen seleccionado
          </span>

          <div class="mv-metric">
            <small>Sucursal origen</small>
            <strong>
              {% for s in sucursales %}
                {% if s.id|stringformat:'s' == sucursal_sel|stringformat:'s' %}
                  {{ s.nombre }}
                {% endif %}
              {% endfor %}
            </strong>
          </div>

          <div class="mv-metric">
            <small>Productos disponibles</small>
            <strong>{{ productos|length|default:0 }}</strong>
          </div>

          <div class="mv-metric">
            <small>Sucursales destino</small>
            <strong>{{ sucursales_destino|length|default:0 }}</strong>
          </div>

        {% else %}

          <div class="mv-empty">
            Selecciona una <strong>sucursal de origen</strong> para ver opciones aquÃ­.
          </div>

        {% endif %}

      </div>
    </div>

  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const productoSelect = document.getElementById("productoSelect");
  const productoMeta   = document.getElementById("productoMeta");
  const metaValidado   = document.getElementById("metaValidado");
  const metaStock      = document.getElementById("metaStock");

  function resetProductoMeta() {
    if (!productoMeta) return;
    metaValidado.textContent = "â€”";
    metaStock.textContent    = "â€”";
    productoMeta.classList.add("is-empty");
  }

  resetProductoMeta();

  if (productoSelect && !productoSelect.disabled) {
    const selectedOpt = productoSelect.options[productoSelect.selectedIndex];
    if (selectedOpt && selectedOpt.dataset.validado) {
      metaValidado.textContent = selectedOpt.dataset.validado || "0";
      metaStock.textContent    = selectedOpt.dataset.stock || "0";
      productoMeta.classList.remove("is-empty");
    }

    productoSelect.addEventListener("change", () => {
      const opt = productoSelect.options[productoSelect.selectedIndex];
      if (!opt || !opt.dataset.validado) {
        resetProductoMeta();
        return;
      }
      metaValidado.textContent = opt.dataset.validado || "0";
      metaStock.textContent    = opt.dataset.stock || "0";
      productoMeta.classList.remove("is-empty");
    });
  }
});
</script>

{% endblock %}
