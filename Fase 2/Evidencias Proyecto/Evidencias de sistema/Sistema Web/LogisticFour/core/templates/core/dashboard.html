{% extends "core/base.html" %}
{% block title %}Tablero ‚Äî Logistic{% endblock %}
{% block content %}

<style>
/* ========================
   ESTILO GENERAL
======================== */
.dashboard-wrap {
  width: 100%;
  padding: 24px 48px 40px;
  animation: fadeIn .3s ease-out both;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: none; }
}

/* ========================
   KPI CARDS
======================== */
.kpis{
  display:grid;
  gap:20px;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  margin-bottom: 22px;
}
.kpi{
  background:white;
  padding:16px 18px;
  border-radius:18px;
  box-shadow:0 5px 16px rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
  gap:4px;
  transition:.18s;
}
.kpi:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 24px rgba(0,0,0,0.09);
}
.kpi .num{ font-size:2.2rem; font-weight:800; color:#0f172a; }
.kpi .lbl{ font-size:.9rem; color:#6b7280; }
.kpi .hint{ font-size:.75rem; color:#9ca3af; }

/* ========================
   GRIDS GENERALES
======================== */
.grid-2{
  display:grid;
  gap:20px;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  margin-bottom:20px;
}

/* ========================
   CARD
======================== */
.card{
  background:white;
  border-radius:22px;
  padding:18px 20px;
  box-shadow:0 8px 22px rgba(0,0,0,.06);
  transition:.18s;
}
.card:hover{
  transform:translateY(-3px);
  box-shadow:0 14px 30px rgba(0,0,0,.08);
}
.card-title{
  font-size:1.2rem;
  font-weight:700;
  color:#0f172a;
  margin-bottom:12px;
}
.card-sub{
  font-size:.8rem;
  color:#9ca3af;
  margin-bottom:10px;
}

/* ========================
   PANEL DE BARRAS HORIZONTALES
======================== */
.metrics-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:16px;
}

.metric-section{
  background:#f9fafb;
  border-radius:16px;
  padding:12px 14px;
  box-shadow:0 4px 12px rgba(15,23,42,0.04);
}

.metric-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:.9rem;
  font-weight:600;
  color:#111827;
  margin-bottom:8px;
}

.metric-title span.dot{
  width:10px;
  height:10px;
  border-radius:3px;
  display:inline-block;
}

.metric-list{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.metric-row{
  display:grid;
  grid-template-columns: 1.2fr 3fr auto;
  align-items:center;
  gap:8px;
  font-size:.8rem;
}

.metric-name{
  color:#111827;
  font-weight:500;
}

.metric-bar{
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
  height:8px;
}
.metric-bar-fill{
  height:100%;
  border-radius:999px;
}
.metric-bar-fill--sucursal{ background:#000000; }
.metric-bar-fill--bodega{ background:#4b5563; }

.metric-value{
  font-variant-numeric:tabular-nums;
  color:#4b5563;
  font-size:.78rem;
}

/* ========================
   TIMELINE / LISTAS
======================== */
.timeline{
  list-style:none;
  padding:0;
  margin:0;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.timeline-item{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  font-size:.8rem;
}
.timeline-main{
  color:#111827;
}
.timeline-meta{
  text-align:right;
  font-size:.75rem;
  color:#9ca3af;
  white-space:nowrap;
}
.pill{
  display:inline-flex;
  align-items:center;
  padding:2px 8px;
  border-radius:999px;
  font-size:.72rem;
  font-weight:500;
}
.pill--warn{
  background:#fef2f2;
  color:#b91c1c;
}
.pill--info{
  background:#eff6ff;
  color:#1d4ed8;
}

/* ========================
   TABLA SUCURSALES
======================== */
.table { width:100%; }
.tr{
  display:grid;
  grid-template-columns: 1fr 140px;
  background:white;
  margin-bottom:8px;
  border-radius:14px;
  box-shadow:0 5px 16px rgba(0,0,0,.05);
}
.tr.th{
  background:#eef1f7;
  font-weight:700;
  box-shadow:none;
}
.tr div{
  padding:12px 14px;
}

/* MOBILE */
@media(max-width:760px){
  .dashboard-wrap{
    padding:18px 14px 32px;
  }
  .tr{
    grid-template-columns:1fr;
    border-left:4px solid #0f172a;
  }
  .tr.th{ display:none; }
  .tr div{
    display:flex;
    justify-content:space-between;
  }
  .tr div::before{
    content: attr(data-label);
    font-weight:600;
  }
}
</style>

<div class="dashboard-wrap">

  <h1 class="h1" style="margin-bottom:16px;">Tablero General</h1>

  <!-- üîπ KPIs superiores -->


  <!-- üîπ Gr√°fico comparativo + resumen -->
  <div class="grid-2">

    <!-- üìä Comparaci√≥n en barras horizontales -->
    <div class="card">
      <div class="card-title">Comparaci√≥n de Stock por Sucursal y Bodega</div>

      <div class="metrics-grid">

        <!-- Sucursales -->
        <div class="metric-section">
          <div class="metric-title">
            <span class="dot" style="background:#000;"></span>
            Sucursales
          </div>
          <div class="metric-list">
            {% if stock_por_sucursal %}
              {% for item in stock_por_sucursal %}
                <div class="metric-row">
                  <div class="metric-name">
                    {{ item.ubicacion_sucursal__sucursal__nombre }}
                  </div>
                  <div class="metric-bar">
                    <div class="metric-bar-fill metric-bar-fill--sucursal"
                         style="width: {{ item.pct }}%;"></div>
                  </div>
                  <div class="metric-value">
                    {{ item.total|floatformat:0 }} u.
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div style="font-size:.8rem;color:#9ca3af;">Sin stock en sucursales.</div>
            {% endif %}
          </div>
        </div>

        <!-- Bodegas -->
        <div class="metric-section">
          <div class="metric-title">
            <span class="dot" style="background:#4b5563;"></span>
            Bodegas
          </div>
          <div class="metric-list">
            {% if stock_por_bodega %}
              {% for item in stock_por_bodega %}
                <div class="metric-row">
                  <div class="metric-name">
                    {{ item.ubicacion_bodega__bodega__nombre }}
                  </div>
                  <div class="metric-bar">
                    <div class="metric-bar-fill metric-bar-fill--bodega"
                         style="width: {{ item.pct }}%;"></div>
                  </div>
                  <div class="metric-value">
                    {{ item.total|floatformat:0 }} u.
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div style="font-size:.8rem;color:#9ca3af;">Sin stock en bodegas.</div>
            {% endif %}
          </div>
        </div>

      </div>
    </div>

    <!-- üìÑ Resumen de stock -->
    <div class="card">
      <div class="card-title">Resumen de Stock</div>
      <ul style="margin:0; padding-left:18px;">
        <li>√çtems con bajo stock: <b>{{ alertas_stock }}</b></li>
        <li>Categor√≠as disponibles: <b>{{ categorias_count }}</b></li>
        <li>Total sucursales con stock: <b>{{ stock_sucursales_count|default:"0" }}</b></li>
        <li>Total bodegas con stock: <b>{{ stock_bodegas_count|default:"0" }}</b></li>
      </ul>
    </div>

  </div>

  <!-- üîπ √öltimos movimientos + alertas recientes -->
  <div class="grid-2">

    <!-- √öltimos movimientos -->
    <div class="card">
      <div class="card-title">√öltimos movimientos de inventario</div>
      <p class="card-sub">√öltimos registros de entradas / salidas</p>
      <ul class="timeline">
        {% if ultimos_movimientos %}
          {% for mov in ultimos_movimientos %}
          <li class="timeline-item">
            <div class="timeline-main">
              {{ mov.producto__nombre|default:mov.producto.nombre }}
              <br>
              <span style="font-size:.75rem;color:#6b7280;">
                {{ mov.tipo_movimiento__nombre|default:mov.tipo_movimiento.nombre }} ¬∑
                {{ mov.cantidad|floatformat:0 }} {{ mov.unidad__codigo|default:mov.unidad.codigo }}
              </span>
            </div>
            <div class="timeline-meta">
              {{ mov.ocurrido_en|date:"d/m H:i" }}
            </div>
          </li>
          {% endfor %}
        {% else %}
          <li style="font-size:.8rem;color:#9ca3af;">A√∫n no hay movimientos registrados.</li>
        {% endif %}
      </ul>
    </div>

    <!-- Alertas recientes -->
    <div class="card">
      <div class="card-title">Alertas recientes</div>
      <p class="card-sub">Eventos importantes detectados por el sistema</p>
      <ul class="timeline">
        {% if alertas_recientes %}
          {% for a in alertas_recientes %}
          <li class="timeline-item">
            <div class="timeline-main">
              <span class="pill pill--warn" style="margin-right:6px;">
                {{ a.severidad|default:"ALERTA" }}
              </span>
              {{ a.mensaje|truncatechars:80 }}
              <br>
              <span style="font-size:.75rem;color:#6b7280;">
                {{ a.producto__sku|default:a.producto.sku }} ¬∑
                {{ a.producto__nombre|default:a.producto.nombre }}
              </span>
            </div>
            <div class="timeline-meta">
              {{ a.creado_en|default:a.creado_en|date:"d/m H:i" }}
            </div>
          </li>
          {% endfor %}
        {% else %}
          <li style="font-size:.8rem;color:#9ca3af;">No hay alertas recientes.</li>
        {% endif %}
      </ul>
    </div>

  </div>

  <!-- üîπ Tabla de sucursales y √≥rdenes -->
  <div class="card">
    <div class="card-title">Sucursales y √ìrdenes</div>

    <div class="table">
      <div class="tr th">
        <div>Sucursal</div>
        <div>√ìrdenes</div>
      </div>

      {% for sucursal in sucursales %}
      <div class="tr">
        <div data-label="Sucursal">{{ sucursal.nombre }}</div>
        <div data-label="√ìrdenes">
          {{ sucursal.transferencias_sucursal_origen.count }} √≥rdenes
        </div>
      </div>
      {% empty %}
      <div class="tr">
        <div>No hay sucursales disponibles.</div>
      </div>
      {% endfor %}
    </div>
  </div>

</div>

{% endblock %}
