{% extends "core/base.html" %}
{% load static %}

{% block title %}Auditoría de Inventario{% endblock %}

{% block content %}
<style>
  :root{ --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#fff; --head:#f8fafc; --pri:#111827; --pri-ink:#fff; }
  .auditoria-wrap{display:grid; gap:16px;}
  .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px;}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{padding:8px 12px; border:1px solid var(--line); border-radius:999px; cursor:pointer; user-select:none}
  .tab.active{background:var(--pri); color:var(--pri-ink); border-color:var(--pri)}
  .table{width:100%; border-collapse:collapse; font-size:14px}
  .table th,.table td{border-bottom:1px solid var(--line); padding:8px; vertical-align:top}
  .sub{color:var(--muted); font-size:12px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width: 860px){ .grid-2{grid-template-columns:1fr} }
</style>

<div class="auditoria-wrap">
  <div class="card">
    <h2 style="margin:0 0 8px">Auditoría de Inventario</h2>
    <form method="get" style="display:flex; gap:8px; flex-wrap:wrap; align-items:end">
      <div>
        <label class="sub">Desde</label>
        <input type="date" name="desde" value="{{ desde|date:'Y-m-d' }}">
      </div>
      <div>
        <label class="sub">Hasta</label>
        <input type="date" name="hasta" value="{{ hasta|date:'Y-m-d' }}">
      </div>
      <div>
        <label class="sub">Producto</label>
        <select name="producto_id">
          <option value="">— Todos —</option>
          {% for p in productos %}
            <option value="{{ p.id }}" {% if producto_id == p.id %}selected{% endif %}>{{ p.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="tab active" type="submit">Aplicar filtros</button>
      <a class="tab" href="{% url 'auditoria_inventario' %}">Limpiar</a>
    </form>
  </div>

  <div class="card">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="movs">Movimientos</div>
      <div class="tab" data-tab="ajustes">Ajustes</div>
      <div class="tab" data-tab="recuentos">Recuentos</div>
      <div class="tab" data-tab="reservas">Reservas</div>
    </div>

    <!-- MOVIMIENTOS -->
    <div class="tab-pane" id="tab-movs" style="margin-top:12px">
      <table class="table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Cant.</th>
            <th>Unidad</th>
            <th>Desde → Hasta</th>
            <th>Lote/Serie</th>
            <th>Ref</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
        {% for m in movimientos %}
          <tr>
            <td>{{ m.ocurrido_en|date:"Y-m-d H:i" }}</td>
            <td>{{ m.tipo_movimiento.codigo }}</td>
            <td>{{ m.producto }}</td>
            <td style="text-align:right">{{ m.cantidad }}</td>
            <td>{{ m.unidad|default:"—" }}</td>
            <td class="sub">
              {% if m.ubicacion_bodega_desde %}B:{{ m.ubicacion_bodega_desde.codigo }} {% endif %}
              {% if m.ubicacion_sucursal_desde %}S:{{ m.ubicacion_sucursal_desde.codigo }} {% endif %}
              →
              {% if m.ubicacion_bodega_hasta %}B:{{ m.ubicacion_bodega_hasta.codigo }} {% endif %}
              {% if m.ubicacion_sucursal_hasta %}S:{{ m.ubicacion_sucursal_hasta.codigo }} {% endif %}
            </td>
            <td class="sub">
              {% if m.lote %}L:{{ m.lote.codigo }}{% endif %}
              {% if m.serie %} {% if m.lote %}<br>{% endif %}S:{{ m.serie.codigo }}{% endif %}
            </td>
            <td class="sub">
              {% if m.tabla_referencia %}{{ m.tabla_referencia }}#{{ m.referencia_id }}{% else %}—{% endif %}
            </td>
            <td class="sub">{{ m.notas|default:"" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="9" class="sub">Sin movimientos en el rango.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- AJUSTES -->
    <div class="tab-pane" id="tab-ajustes" style="display:none; margin-top:12px">
      <div class="grid-2">
        <div>
          <h4 style="margin:0 0 8px">Cabeceras de Ajuste</h4>
          <table class="table">
            <thead><tr><th>Fecha</th><th>Bodega</th><th>Motivo</th><th>Usuario</th><th>Estado</th></tr></thead>
            <tbody>
              {% for a in ajustes %}
              <tr>
                <td>{{ a.creado_en|date:"Y-m-d H:i" }}</td>
                <td>{{ a.bodega|default:"—" }}</td>
                <td>{{ a.motivo|default:"" }}</td>
                <td>{{ a.creado_por|default:"—" }}</td>
                <td>{{ a.estado }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="sub">Sin ajustes en el rango.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 8px">Líneas de Ajuste</h4>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th><th>Producto</th><th>Ubicación</th><th>Lote/Serie</th><th>Δ Cant.</th><th>Motivo</th>
              </tr>
            </thead>
            <tbody>
              {% for l in lineas_ajuste %}
              <tr>
                <td>{{ l.ajuste.creado_en|date:"Y-m-d H:i" }}</td>
                <td>{{ l.producto }}</td>
                <td class="sub">
                  {% if l.ubicacion_bodega %}B:{{ l.ubicacion_bodega.codigo }} {% endif %}
                  {% if l.ubicacion_sucursal %}S:{{ l.ubicacion_sucursal.codigo }}{% endif %}
                </td>
                <td class="sub">
                  {% if l.lote %}L:{{ l.lote.codigo }}{% endif %}
                  {% if l.serie %} {% if l.lote %}<br>{% endif %}S:{{ l.serie.codigo }}{% endif %}
                </td>
                <td style="text-align:right">{{ l.cantidad_delta }}</td>
                <td class="sub">{{ l.motivo|default:"" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="sub">Sin líneas de ajuste en el rango.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RECUENTOS -->
    <div class="tab-pane" id="tab-recuentos" style="display:none; margin-top:12px">
      <div class="grid-2">
        <div>
          <h4 style="margin:0 0 8px">Cabeceras de Recuento</h4>
          <table class="table">
            <thead><tr><th>Fecha</th><th>Bodega</th><th>Ciclo</th><th>Usuario</th><th>Estado</th></tr></thead>
            <tbody>
              {% for r in recuentos %}
              <tr>
                <td>{{ r.creado_en|date:"Y-m-d H:i" }}</td>
                <td>{{ r.bodega|default:"—" }}</td>
                <td>{{ r.codigo_ciclo }}</td>
                <td>{{ r.creado_por|default:"—" }}</td>
                <td>{{ r.estado }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="sub">Sin recuentos en el rango.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 8px">Líneas de Recuento</h4>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th><th>Producto</th><th>Ubicación</th>
                <th>Sistema</th><th>Contada</th><th>Diferencia</th><th>Contado por</th>
              </tr>
            </thead>
            <tbody>
              {% for l in lineas_recuento %}
              <tr>
                <td>{{ l.recuento.creado_en|date:"Y-m-d H:i" }}</td>
                <td>{{ l.producto }}</td>
                <td class="sub">
                  {% if l.ubicacion_bodega %}B:{{ l.ubicacion_bodega.codigo }} {% endif %}
                  {% if l.ubicacion_sucursal %}S:{{ l.ubicacion_sucursal.codigo }}{% endif %}
                </td>
                <td style="text-align:right">{{ l.cantidad_sistema }}</td>
                <td style="text-align:right">{{ l.cantidad_contada }}</td>
                <td style="text-align:right">{{ l.diferencia }}</td>
                <td class="sub">{{ l.contado_por|default:"—" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="sub">Sin líneas de recuento en el rango.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RESERVAS -->
    <div class="tab-pane" id="tab-reservas" style="display:none; margin-top:12px">
      <table class="table">
        <thead>
          <tr>
            <th>Fecha</th><th>Producto</th><th>Ubicación</th><th>Lote/Serie</th>
            <th>Cant. Reservada</th><th>Referencia</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reservas %}
          <tr>
            <td>{{ r.creado_en|date:"Y-m-d H:i" }}</td>
            <td>{{ r.producto }}</td>
            <td class="sub">
              {% if r.ubicacion_bodega %}B:{{ r.ubicacion_bodega.codigo }} {% endif %}
              {% if r.ubicacion_sucursal %}S:{{ r.ubicacion_sucursal.codigo }}{% endif %}
            </td>
            <td class="sub">
              {% if r.lote %}L:{{ r.lote.codigo }}{% endif %}
              {% if r.serie %} {% if r.lote %}<br>{% endif %}S:{{ r.serie.codigo }}{% endif %}
            </td>
            <td style="text-align:right">{{ r.cantidad_reservada }}</td>
            <td class="sub">
              {% if r.tabla_referencia %}{{ r.tabla_referencia }}#{{ r.referencia_id }}{% else %}—{% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="sub">Sin reservas en el rango.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  (function(){
    const tabs = document.querySelectorAll('#tabs .tab');
    const panes = {
      movs: document.getElementById('tab-movs'),
      ajustes: document.getElementById('tab-ajustes'),
      recuentos: document.getElementById('tab-recuentos'),
      reservas: document.getElementById('tab-reservas'),
    };
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const key = t.dataset.tab;
        Object.values(panes).forEach(p=>p.style.display='none');
        panes[key].style.display = 'block';
      });
    });
  })();
</script>
{% endblock %}
