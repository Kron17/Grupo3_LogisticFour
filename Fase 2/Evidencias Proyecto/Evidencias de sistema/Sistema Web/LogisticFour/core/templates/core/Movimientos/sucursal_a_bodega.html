{% extends "core/base.html" %}
{% load static %}
{% block title %}Movimiento de Sucursal a Bodega{% endblock %}

{% block content %}
<style>
  :root {
    --ink: #0f172a;
    --muted: #6b7280;
    --line: #e5e7eb;
    --bg: #f3f4f6;
    --card: #ffffff;
    --accent: #111827;
    --success-bg: #ecfdf5;
    --success-border: #a7f3d0;
    --success-ink: #065f46;
    --error-bg: #fef2f2;
    --error-border: #fecaca;
    --error-ink: #991b1b;
  }

  .mv-shell {
    max-width: 1080px;
    margin-inline: auto;
    display: grid;
    gap: 18px;
    padding-bottom: 18px;
  }

  .mv-head {
    display: flex;
    justify-content: space-between;
    gap: 14px;
    align-items: center;
  }

  .mv-title {
    font-weight: 800;
    font-size: clamp(1.35rem, 2.4vw, 1.65rem);
    margin: 0;
    display: flex;
    gap: .65rem;
    align-items: center;
  }

  .mv-title-badge {
    background: #e2e8f0;
    color: #0f172a;
    border-radius: 999px;
    padding: 3px 10px 4px;
    font-size: .70rem;
    text-transform: uppercase;
    letter-spacing: .04em;
  }

  .mv-sub {
    margin: 0;
    color: var(--muted);
    font-size: .86rem;
  }

  .mv-formwrap {
    display: grid;
    gap: 14px;
    grid-template-columns: 1.1fr .9fr;
  }

  .mv-card {
    background: var(--card);
    border: 1px solid rgba(226,232,240,.8);
    border-radius: 14px;
    box-shadow: 0 12px 35px rgba(15,23,42,.04);
    animation: fadeUp .35s ease;
  }

  .mv-card-body {
    padding: 16px 16px 6px 16px;
  }

  .mv-form {
    display: grid;
    gap: 12px;
  }

  .mv-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .mv-label {
    font-weight: 600;
    color: var(--ink);
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .mv-label small {
    color: var(--muted);
    font-weight: 400;
  }

  .mv-input,
  .mv-select {
    width: 100%;
    padding: 9px 11px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    background: #f8fafc;
    outline: none;
    transition: box-shadow .15s ease, border .15s ease, background .15s ease;
    font-size: .9rem;
  }

  .mv-input:focus,
  .mv-select:focus {
    border-color: rgba(17,24,39,.55);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(15,23,42,.08);
  }

  .mv-input[disabled],
  .mv-select[disabled] {
    background: #e5e7eb;
    cursor: not-allowed;
    opacity: .8;
  }

  .mv-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 9.5px 14px 9px;
    font-weight: 600;
    display: inline-flex;
    gap: 6px;
    align-items: center;
    cursor: pointer;
    text-decoration: none;
    font-size: .9rem;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  }

  .mv-btn:hover {
    background: #000;
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(15,23,42,.15);
  }

  .mv-btn:active { transform: translateY(0); }

  .mv-btn-ghost {
    background: #ffffff;
    border-radius: 999px;
    border: 1px solid rgba(22, 163, 74, .4);
    padding: 6px 14px;
    font-size: .82rem;
    font-weight: 600;
    color: var(--success-ink);
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    text-decoration: none;
  }

  .mv-btn-ghost:hover {
    background: #f0fdf4;
  }

  .mv-messages {
    margin-top: 14px;
    display: grid;
    gap: 8px;
  }

  .msg-success {
    background: var(--success-bg);
    border: 1px solid var(--success-border);
    color: var(--success-ink);
    border-radius: 10px;
    padding: 10px 12px;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }

  .msg-error {
    background: var(--error-bg);
    border: 1px solid var(--error-border);
    color: var(--error-ink);
    border-radius: 10px;
    padding: 10px 12px;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .msg-icon {
    width: 26px;
    height: 26px;
    background: rgba(255,255,255,.65);
    border-radius: 999px;
    display: grid;
    place-items: center;
    font-weight: 700;
  }

  .mv-side {
    border-inline: 0;
  }

  .mv-side-head {
    padding: 14px 16px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .mv-side-title { font-weight: 600; }

  .mv-side-grid {
    display: grid;
    gap: 8px;
    padding: 14px 16px 16px;
  }

  .mv-metric {
    background: #f8fafc;
    border: 1px solid rgba(148,163,184,.25);
    border-radius: 14px;
    padding: 10px 12px;
    display: grid;
    gap: 3px;
  }

  .mv-metric small { color: var(--muted); }

  .mv-metric strong { font-size: 1.35rem; }

  .mv-loading {
    font-size: .8rem;
    color: var(--muted);
  }

  /* ==== Chips validado vs stock total ==== */
  .mv-product-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
    font-size: .78rem;
    transition: opacity .15s ease;
  }

  .mv-product-meta.is-empty {
    opacity: .6;
  }

  .mv-chip {
    border-radius: 999px;
    padding: 3px 9px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .mv-chip-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: currentColor;
  }

  .mv-chip-valid {
    background: #dcfce7;
    color: #166534;
  }

  .mv-chip-stock {
    background: #e0f2fe;
    color: #075985;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(5px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 1000px) {
    .mv-formwrap { grid-template-columns: 1fr; }
  }

  @media (max-width: 640px) {
    .mv-card-body,
    .mv-side-grid { padding-inline: 12px; }
    .mv-head { flex-direction: column; align-items: flex-start; }
  }
</style>

<div class="mv-shell">
  <div class="mv-head">
    <div>
      <h1 class="mv-title">
        <span>Movimiento de Sucursal a Bodega</span>
        <span class="mv-title-badge">Inventario</span>
      </h1>
      <p class="mv-sub">
        Elige primero la sucursal de origen y luego la bodega a la que quieres devolver el producto.
      </p>
    </div>
  </div>

  <div class="mv-formwrap">
    <!-- FORM -->
    <div class="mv-card">
      <div class="mv-card-body">
        <form method="POST" class="mv-form">
          {% csrf_token %}

          <!-- Sucursal origen -->
          <div class="mv-field">
            <label for="sucursalSelect" class="mv-label">
              Sucursal origen
              <small>obligatorio</small>
            </label>
            <select name="sucursal" id="sucursalSelect" class="mv-select" required>
              <option value="">â€” Selecciona una sucursal â€”</option>
              {% for s in sucursales %}
                <option value="{{ s.id }}"
                        {% if s.id|stringformat:"s" == sucursal_sel|stringformat:"s" %}selected{% endif %}>
                  {{ s.codigo }} â€” {{ s.nombre }}
                </option>
              {% endfor %}
            </select>
            <small class="mv-loading">De aquÃ­ se descontarÃ¡ el stock.</small>
          </div>

          <!-- Bodega -->
          <div class="mv-field">
            <label for="bodegaSelect" class="mv-label">
              Bodega
              <small>obligatorio</small>
            </label>
            <select name="bodega" id="bodegaSelect"
                    class="mv-select" required
                    onchange="this.form.submit()">
              <option value="">â€” Selecciona una bodega â€”</option>
              {% for b in bodegas %}
                <option value="{{ b.id }}"
                        {% if b.id|stringformat:"s" == bodega_sel|stringformat:"s" %}selected{% endif %}>
                  {{ b.codigo }} â€” {{ b.nombre }}
                </option>
              {% endfor %}
            </select>
            <p class="mv-loading">Se validarÃ¡ que la sucursal pertenezca a esta bodega.</p>
          </div>

          <!-- Producto -->
          <div class="mv-field">
            <label for="productoSelect" class="mv-label">
              Producto a devolver
            </label>

            {# productos == None â†’ aÃºn no cargados
               productos vacÃ­o â†’ sucursal sin productos validados #}
            {% if productos is not None %}
              {% if productos %}
                <select name="producto" id="productoSelect" class="mv-select" required>
                  <option value="">â€” Selecciona un producto â€”</option>
                  {% for p in productos %}
                    <option
                      value="{{ p.id }}"
                      data-validado="{{ p.stock_validado|floatformat:0 }}"
                      data-stock="{{ p.stock_total|floatformat:0 }}"
                    >
                      {{ p.sku }} â€” {{ p.nombre }}
                      â€” âœ… {{ p.stock_validado|floatformat:0 }} val. Â· ðŸ“¦ {{ p.stock_total|floatformat:0 }} stock
                    </option>
                  {% endfor %}
                </select>
                <small class="mv-loading">
                  Solo se muestran productos con stock <strong>validado</strong> en la sucursal origen.
                </small>
              {% else %}
                <select id="productoSelect" class="mv-select" disabled>
                  <option>No hay productos con stock validado en esta sucursal.</option>
                </select>
                <small class="mv-loading">
                  Valida productos en la sucursal para poder devolverlos a bodega.
                </small>
              {% endif %}
            {% else %}
              <select id="productoSelect" class="mv-select" disabled>
                <option>Elige sucursal + bodega y vuelve a enviar para ver productosâ€¦</option>
              </select>
              <small class="mv-loading">
                Primero selecciona la sucursal y la bodega.
              </small>
            {% endif %}

            <!-- Chips verde/azul -->
            <div class="mv-product-meta is-empty" id="productoMeta" aria-live="polite">
              <span class="mv-chip mv-chip-valid">
                <span class="mv-chip-dot"></span>
                Validado: <span id="metaValidado">â€”</span>
              </span>
              <span class="mv-chip mv-chip-stock">
                <span class="mv-chip-dot"></span>
                Stock total: <span id="metaStock">â€”</span>
              </span>
            </div>
          </div>

          <!-- Cantidad -->
          <div class="mv-field" style="max-width: 200px;">
            <label for="cantidadInput" class="mv-label">
              Cantidad
            </label>
            <input type="number" name="cantidad" id="cantidadInput"
                   min="1" step="1" class="mv-input" required>
          </div>

          <!-- BotÃ³n principal -->
          <button type="submit" class="mv-btn">
            <span aria-hidden="true">â‡„</span>
            <span>Devolver a bodega</span>
          </button>

          <!-- Mensajes -->
          <div class="mv-messages">
            {% if success %}
              <div class="msg-success">
                <span class="msg-icon">âœ“</span>
                <div>
                  <div>{{ success }}</div>
                  {% if transferencia_id %}
                    <div style="margin-top:6px;">
                      <a href="{% url 'detalle_transferencia' transferencia_id %}"
                         class="mv-btn-ghost">
                        Ver guÃ­a de despacho
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if error %}
              <div class="msg-error">
                <span class="msg-icon">!</span>
                <div>{{ error }}</div>
              </div>
            {% endif %}
          </div>
        </form>
      </div>
    </div>

    <!-- LATERAL / INFO -->
    <div class="mv-card mv-side" aria-label="Resumen rÃ¡pido">
      <div class="mv-side-head">
        <div>
          <p class="mv-side-title">Resumen del movimiento</p>
          <p class="mv-sub" style="margin-top:2px;">Datos segÃºn selecciÃ³n actual.</p>
        </div>
      </div>
      <div class="mv-side-grid">
        <div class="mv-metric">
          <small>Sucursales totales</small>
          <strong>{{ sucursales|length|default:0 }}</strong>
        </div>
        <div class="mv-metric">
          <small>Productos con stock en sucursal</small>
          <strong>{{ productos|length|default:0 }}</strong>
        </div>
        <div class="mv-metric">
          <small>Estado</small>
          <span class="mv-loading">
            {% if bodega_sel and sucursal_sel %}
              Listo para mover (revisa stock y cantidad).
            {% else %}
              Selecciona sucursal y bodega para comenzar.
            {% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const productoSelect = document.getElementById("productoSelect");
  const productoMeta   = document.getElementById("productoMeta");
  const metaValidado   = document.getElementById("metaValidado");
  const metaStock      = document.getElementById("metaStock");

  function resetProductoMeta() {
    if (!productoMeta) return;
    metaValidado.textContent = "â€”";
    metaStock.textContent    = "â€”";
    productoMeta.classList.add("is-empty");
  }

  resetProductoMeta();

  if (productoSelect && !productoSelect.disabled) {
    // Por si llega seleccionado tras un POST con error
    const initial = productoSelect.options[productoSelect.selectedIndex];
    if (initial && initial.dataset.validado) {
      metaValidado.textContent = initial.dataset.validado || "0";
      metaStock.textContent    = initial.dataset.stock || "0";
      productoMeta.classList.remove("is-empty");
    }

    productoSelect.addEventListener("change", () => {
      const opt = productoSelect.options[productoSelect.selectedIndex];
      if (!opt || !opt.dataset.validado) {
        resetProductoMeta();
        return;
      }
      metaValidado.textContent = opt.dataset.validado || "0";
      metaStock.textContent    = opt.dataset.stock || "0";
      productoMeta.classList.remove("is-empty");
    });
  }
});
</script>

{% endblock %}
