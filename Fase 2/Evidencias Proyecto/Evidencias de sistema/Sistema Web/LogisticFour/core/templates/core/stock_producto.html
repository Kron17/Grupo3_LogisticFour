{% extends "core/base.html" %}
{% load static %}
{% block title %}Ver stock por producto{% endblock %}
{% load humanize %}


{% block content %}
<style>
  .page-wrap { max-width: 1400px; margin-inline: auto; }
  .fade-in { animation: fadeIn .35s ease both; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }

  .empty {
    border:1px dashed var(--bs-border-color);
    border-radius:1rem;
    padding:1rem;
    color:var(--bs-secondary-color);
    background:var(--bs-tertiary-bg);
  }
  .btn-action{ min-width:140px }

  /* botÃ³n de cÃ¡mara pegado al input */
  .btn-scan{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:46px
  }
  .btn-scan svg{ width:20px; height:20px }

  /* ==== estilos del modal del escÃ¡ner ==== */
  .bs-cam{position:relative;border-radius:16px;overflow:hidden;background:#0b0b0b}
  .bs-vid{width:100%;height:100%;object-fit:cover;background:#000}
  .bs-overlay{position:absolute;inset:0;pointer-events:none;display:none}
  .bs-mask{position:absolute;inset:0;background:
    linear-gradient(to bottom,rgba(0,0,0,.5) calc((100% - 32%)/2),
    transparent calc((100% - 32%)/2), transparent calc((100% + 32%)/2),
    rgba(0,0,0,.5) calc((100% + 32%)/2)) }
  .bs-frame{position:absolute;left:6%;right:6%;top:calc((100% - 32%)/2);height:32%;
    border:2px dashed rgba(255,255,255,.8);border-radius:12px}
  .bs-fab{position:absolute;top:8px;right:8px;display:flex;gap:6px;z-index:5}
  .bs-fab .btn{padding:.35rem .55rem;line-height:1}
  .bs-primary{display:block;width:100%;padding:.9rem 1rem;font-size:1.05rem}

  .metric {
    border: 1px solid var(--bs-border-color);
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    background: var(--bs-body-bg);
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .metric:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(0,0,0,.06); }
  .metric .label { font-size:.825rem; color: var(--bs-secondary-color); }
  .metric .value { font-weight: 700; font-size: clamp(1.2rem, 1.1rem + .6vw, 1.8rem); }

  .card-soft {
    border-radius: 1rem;
    border: 1px solid var(--bs-border-color);
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
  }
  .sku-chip {
    background: var(--bs-tertiary-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 999px;
    padding: .25rem .6rem;
    font-size:.85rem;
  }

  .table thead th { position: sticky; top: 0; background: var(--bs-body-bg); z-index: 1; }
  .td-num { text-align: right; white-space: nowrap; }

  /* ===== secciÃ³n grÃ¡fico ===== */
  .chart-card .card-body{
    padding: 1rem 1.25rem 1.5rem;
  }
  .chart-wrapper{
    position:relative;
    width:100%;
    min-height:260px;
  }
  @media (max-width: 767.98px){
    .chart-wrapper{ min-height:220px; }
  }
</style>

<div class="container-fluid py-4">
  <div class="page-wrap">
    <!-- Buscador -->
    <div class="mb-4">
      <form method="get" action="{% url 'stock-por-producto' %}"
            class="row g-3 align-items-center fade-in" id="searchForm">
        <div class="col-12 col-lg-7 col-xxl-8">
          <div class="input-group input-group-lg">
            <button type="button" class="btn btn-outline-secondary btn-scan" id="btnOpenScanner"
                    title="Escanear con cÃ¡mara" aria-label="Escanear con cÃ¡mara">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
            </button>
            <input id="skuInput" name="sku" class="form-control"
                   placeholder="Escanea o escribe el SKU (ej. 001-002-117)"
                   value="{{ sku|default:'' }}" autocomplete="off" autofocus>
          </div>
        </div>
        <div class="col-12 col-lg-5 col-xxl-4">
          <div class="d-flex gap-3">
            <button class="btn btn-primary btn-lg btn-action" id="btnSubmit" type="submit">
              Buscar
            </button>
            <a class="btn btn-outline-secondary btn-lg btn-action" href="{% url 'stock-por-producto' %}">Limpiar</a>
          </div>
        </div>
      </form>
    </div>

    {# MENSAJES DJANGO #}
    {% if messages %}
      <div class="mb-3">
        {% for m in messages %}
          <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {% if producto %}
      <!-- Header producto -->
      <div class="card card-soft mb-3 fade-in">
        <div class="card-body d-flex flex-wrap gap-3 justify-content-between align-items-start">
          <div>
            <h4 class="mb-1">{{ producto.nombre }}</h4>
            <div class="d-flex flex-wrap gap-2 small mb-1">
              <span class="sku-chip">SKU: <strong>{{ producto.sku }}</strong></span>
              <span class="sku-chip">Marca: <strong>{{ producto.marca|default:"â€”" }}</strong></span>
              <span class="sku-chip">CategorÃ­a: <strong>{{ producto.categoria|default:"â€”" }}</strong></span>
            </div>
            {% if producto.descripcion %}
              <p class="text-secondary small mb-0">{{ producto.descripcion|truncatechars:160 }}</p>
            {% endif %}
          </div>
          <div class="d-flex gap-2">
            <button id="copySku" class="btn btn-outline-secondary">Copiar SKU</button>
            <a href="{% url 'producto-detail' producto.id %}" class="btn btn-outline-primary">Ver ficha</a>
          </div>
        </div>
      </div>

      <!-- MÃ©tricas -->
    <div class="row g-3 mb-4">
      <!-- Disponible total -->
      <div class="col-12 col-md-4">
        <div class="metric h-100">
          <div class="label">Disponible total</div>
          <div class="value text-success">
            {{ totales.total_disponible|default_if_none:0|floatformat:0 }}
          </div>
        </div>
      </div>

      <!-- Precio unitario -->
      <div class="col-12 col-md-4">
        <div class="metric h-100">
          <div class="label">Precio unitario</div>
          <div class="value {% if totales.precio_unitario|default:0 > 0 %}text-primary{% else %}text-body{% endif %}">
            ${{ totales.precio_unitario|default_if_none:0|floatformat:0|intcomma }}
          </div>
        </div>
      </div>

      <!-- Valor total (precio Ã— stock) -->
      <div class="col-12 col-md-4">
        <div class="metric h-100">
          <div class="label">Valor total</div>
          <div class="value {% if totales.valor_total|default:0 > 0 %}text-primary{% else %}text-body{% endif %}">
            ${{ totales.valor_total|default_if_none:0|floatformat:0|intcomma }}
          </div>
        </div>
      </div>
    </div>

      {# === NUEVO: grÃ¡fico + tabla por ubicaciÃ³n interna === #}
      {% if ubicaciones_detalle %}
      <div class="row g-3 mb-4 fade-in">
        <div class="col-12 col-xl-6">
          <div class="card card-soft chart-card h-100">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
              <strong>ComparaciÃ³n por ubicaciÃ³n</strong>
              <small class="text-secondary">Disponible por ubicaciÃ³n interna</small>
            </div>
            <div class="card-body">
              <div class="chart-wrapper">
                <canvas id="ubicacionesChart" aria-label="GrÃ¡fico de stock por ubicaciÃ³n" role="img"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-xl-6">
          <div class="card card-soft h-100">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
              <strong>Stock por ubicaciÃ³n</strong>
              <span class="text-secondary small">{{ ubicaciones_detalle|length }} ubicaciÃ³n(es)</span>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead class="border-bottom">
                    <tr>
                      <th>Sucursal</th>
                      <th>Bodega</th>
                      <th>UbicaciÃ³n</th>
                      <th class="td-num">Disponible</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for u in ubicaciones_detalle %}
                      <tr>
                        <td>
                          {% if u.sucursal_codigo %}
                            <span class="fw-semibold">{{ u.sucursal_codigo }}</span>
                            <span class="text-secondary"> â€” {{ u.sucursal_nombre }}</span>
                          {% else %}
                            <span class="text-secondary">â€”</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if u.bodega_codigo %}
                            <span class="fw-semibold">{{ u.bodega_codigo }}</span>
                            <span class="text-secondary"> â€” {{ u.bodega_nombre }}</span>
                          {% else %}
                            <span class="text-secondary">â€”</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if u.ubicacion_codigo %}
                            <span class="badge rounded-pill bg-light border text-body fw-medium">
                              {{ u.ubicacion_codigo }}
                              {% if u.ubicacion_area %}
                                <span class="text-secondary"> Â· {{ u.ubicacion_area }}</span>
                              {% endif %}
                            </span>
                          {% else %}
                            <span class="text-secondary">â€”</span>
                          {% endif %}
                        </td>
                        <td class="td-num">
                          {{ u.total_disponible|default:0|floatformat:0 }}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Resumen por sucursal/bodega -->
      <div class="card card-soft mb-4 fade-in">
        <div class="card-header bg-transparent">
          <div class="d-flex align-items-center justify-content-between">
            <strong>Resumen por sucursal / bodega</strong>
            <span class="text-secondary small">{{ resumen_sucursales|length }} registro(s)</span>
          </div>
        </div>
        <div class="card-body p-0">
          {% if resumen_sucursales %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead class="border-bottom">
                  <tr>
                    <th style="min-width: 200px;">Sucursal</th>
                    <th style="min-width: 200px;">Bodega</th>
                    <th class="td-num" style="width: 15%;">Disponible</th>
                    <th class="td-num" style="width: 15%;">Neto</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in resumen_sucursales %}
                  <tr class="fade-in" style="animation-delay: {{ forloop.counter0 }}0ms;">
                    <td data-label="Sucursal">
                      {% if r.sucursal_codigo %}
                        <span class="fw-semibold">{{ r.sucursal_codigo }}</span>
                        <span class="text-secondary">â€” {{ r.sucursal_nombre }}</span>
                      {% else %}
                        <span class="text-secondary">â€”</span>
                      {% endif %}
                    </td>
                    <td data-label="Bodega">
                      {% if r.bodega_codigo %}
                        <span class="fw-semibold">{{ r.bodega_codigo }}</span>
                        <span class="text-secondary">â€” {{ r.bodega_nombre }}</span>
                      {% else %}
                        <span class="text-secondary">â€”</span>
                      {% endif %}
                    </td>
                    <td class="td-num" data-label="Disponible">
                      {{ r.total_disponible|default:0|floatformat:0 }}
                    </td>
                    <td class="td-num fw-semibold" data-label="Neto">
                      {{ r.total_neto|default:0|floatformat:0 }}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-4 empty">No hay stock registrado por sucursal/bodega para este producto.</div>
          {% endif %}
        </div>
      </div>

      <!-- AcordeÃ³n agrupado por sucursal -->
      <div class="card card-soft fade-in">
        <div class="card-header bg-transparent">
          <div class="d-flex align-items-center justify-content-between">
            <strong>Detalle agrupado por sucursal</strong>
            <span class="text-secondary small">vista agrupada</span>
          </div>
        </div>
        <div class="card-body">
          {% if resumen_sucursales %}
            {% regroup resumen_sucursales by sucursal_codigo as grupos %}
            <div class="accordion" id="accStock">
              {% for g in grupos %}
                {% with scode=g.grouper %}
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#suc-{{ scode|default:'sin-sucursal'|slugify }}"
                              aria-expanded="false">
                        <div class="d-flex flex-column">
                          {% if scode %}
                            <span class="fw-semibold">Sucursal {{ scode }}</span>
                            <small class="text-secondary">
                              {{ g.list.0.sucursal_nombre }}
                              Â· {{ g.list|length }} registro(s)
                            </small>
                          {% else %}
                            <span class="fw-semibold">Sin sucursal (stock en bodegas)</span>
                            <small class="text-secondary">{{ g.list|length }} registro(s)</small>
                          {% endif %}
                        </div>
                      </button>
                    </h2>
                    <div id="suc-{{ scode|default:'sin-sucursal'|slugify }}" class="accordion-collapse collapse"
                         data-bs-parent="#accStock">
                      <div class="accordion-body">
                        <div class="table-responsive">
                          <table class="table align-middle mb-0">
                            <thead class="border-bottom">
                              <tr>
                                <th>Bodega</th>
                                <th class="td-num">Disponible</th>
                                <th class="td-num">Neto</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for r in g.list %}
                              <tr>
                                <td>
                                  {% if r.bodega_codigo %}
                                    <span class="fw-semibold">{{ r.bodega_codigo }}</span>
                                    <span class="text-secondary">â€” {{ r.bodega_nombre }}</span>
                                  {% else %}
                                    <span class="text-secondary">â€”</span>
                                  {% endif %}
                                </td>
                                <td class="td-num">{{ r.total_disponible|default:0|floatformat:0 }}</td>
                                <td class="td-num fw-semibold">{{ r.total_neto|default:0|floatformat:0 }}</td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endwith %}
              {% endfor %}
            </div>
          {% else %}
            <div class="empty">No hay datos para agrupar.</div>
          {% endif %}
        </div>
      </div>

    {% elif sku %}
      <div class="empty fade-in">Producto no encontrado.</div>
    {% else %}
      <div class="empty fade-in">Escribe o escanea un SKU para comenzar.</div>
    {% endif %}
  </div>
</div>

{# Quita estas dos lÃ­neas si Bootstrap ya estÃ¡ en base.html #}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{# Chart.js para el grÃ¡fico (blanco y negro) #}
{% if producto and ubicaciones_detalle %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function(){
    const labels = {{ chart_labels_json|safe }};
    const data   = {{ chart_values_json|safe }};

    if (!labels.length) return;
    const canvas = document.getElementById('ubicacionesChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Disponible',
          data: data,
          backgroundColor: 'rgba(0,0,0,0.85)',   // negro semi-opaco
          borderColor: '#000000',                // negro
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 36,
        }]
      },
      options: {
        indexAxis: 'y', // barras horizontales
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: { top: 10, right: 20, bottom: 10, left: 10 }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#000000',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#ffffff',
            borderWidth: 1,
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: { color: '#00000015', borderColor: '#000000' },
            ticks: { color: '#000000' },
          },
          y: {
            grid: { display: false, borderColor: '#00000020' },
            ticks: {
              color: '#000000',
              autoSkip: false,
              maxRotation: 0,
              minRotation: 0,
            }
          }
        },
        animation: {
          duration: 650,
          easing: 'easeOutCubic'
        }
      }
    });
  })();
</script>

{% endif %}

<script>
/* ===== EscÃ¡ner minimal (igual que antes) ===== */
(function(){
  const ZXING_URL="https://unpkg.com/@zxing/library@0.21.3";
  const QUAGGA_URL="https://unpkg.com/quagga2@1.8.4/dist/quagga.js";
  const ROI_RATIO=0.32, LIVE_INTERVAL_MS=550, SCALE_MAX_W=1200, FALLBACK_EVERY=4;

  const qs=(s,r=document)=>r.querySelector(s);
  const loadOnce=(src)=>new Promise((ok,ko)=>{
    if(document.querySelector(`script[src^="${src}"]`)) return ok();
    const s=document.createElement('script'); s.src=src; s.onload=ok; s.onerror=ko; document.head.appendChild(s);
  });
  const ensureLibs=()=>Promise.all([loadOnce(ZXING_URL),loadOnce(QUAGGA_URL)]);
  const show=(el,msg,ok=true)=>{el.className=`alert ${ok?'alert-success':'alert-danger'} mt-2`;el.textContent=msg;el.classList.remove('d-none')};
  const info=(el,msg)=>{el.className='alert alert-info mt-2';el.textContent=msg;el.classList.remove('d-none')};
  const hide=(el)=>el.classList.add('d-none');

  function ensureModal(){
    if(qs('#barcodeModal')) return;
    const html = `
    <div class="modal fade" id="barcodeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down" style="max-width:950px">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bsTitle">Escanear cÃ³digo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="ratio ratio-16x9 bs-cam" id="bsCamBox">
              <video id="bsVideo" class="bs-vid" playsinline muted></video>
              <div class="bs-overlay" id="bsOverlay"><div class="bs-mask"></div><div class="bs-frame"></div></div>
              <div class="bs-fab">
                <button id="bsFlip" class="btn btn-light btn-sm" title="Cambiar cÃ¡mara">â†º</button>
                <button id="bsTorch" class="btn btn-warning btn-sm d-none" title="Linterna">ðŸ’¡</button>
              </div>
            </div>
            <button id="bsLive" class="btn btn-primary bs-primary mt-3">Escanear</button>
            <div id="bsResult" class="alert alert-info d-none mt-2"></div>
          </div>
          <div class="modal-footer">
            <small class="text-muted me-auto">FPS: <span id="bsFps">0</span></small>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>`;
    const d=document.createElement('div'); d.innerHTML=html; document.body.appendChild(d.firstElementChild);
  }

  function drawScaled(img,maxW){
    const sc=Math.min(1,maxW/img.width), w=Math.round(img.width*sc), h=Math.round(img.height*sc);
    const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); return c;
  }
  function captureROI(video){
    const vw=video.videoWidth||1280, vh=video.videoHeight||720;
    const rh=Math.floor(vh*ROI_RATIO), y=Math.floor((vh-rh)/2);
    const c=document.createElement('canvas'); c.width=vw; c.height=rh;
    c.getContext('2d').drawImage(video,0,y,vw,rh,0,0,vw,rh);
    return c.toDataURL('image/png');
  }
  async function tryZXing(img,formats){
    try{
      const hints=new Map(), set=[];
      (formats||[]).forEach(f=> ZXing.BarcodeFormat[f] && set.push(ZXing.BarcodeFormat[f]));
      if(set.length) hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,set);
      hints.set(ZXing.DecodeHintType.TRY_HARDER,true);
      const reader=new ZXing.BrowserMultiFormatReader();
      const res=await reader.decodeFromImage(img,hints).catch(()=>null);
      if(!res) return null;
      return (typeof res.getText==='function') ? res.getText() : (res.text||null);
    }catch{ return null; }
  }
  function tryQuaggaFromCanvas(canvas){
    return new Promise(resolve=>{
      try{
        Quagga.decodeSingle({
          src: canvas.toDataURL('image/png'), numOfWorkers:0,
          inputStream:{ size:SCALE_MAX_W },
          decoder:{ readers:["ean_reader","ean_8_reader","upc_reader","upc_e_reader","code_128_reader","code_39_reader"] },
          locate:true
        }, r=> resolve(r && r.codeResult && r.codeResult.code ? r.codeResult.code : null));
      }catch{ resolve(null); }
    });
  }
  async function decodeDataURLTo(target,label,dataUrl,fast=false, ref={val:0}){
    try{
      info(target,`Procesando ${label}â€¦`);
      const img=await new Promise((ok,ko)=>{const i=new Image();i.onload=()=>ok(i);i.onerror=ko;i.src=dataUrl;});
      const canvas=drawScaled(img,SCALE_MAX_W);

      let code=await tryZXing(img,["EAN_13"]);
      if(code){ show(target,`LeÃ­do (${label}/ZXing): ${code}`,true); try{navigator.vibrate&&navigator.vibrate(25)}catch{}; return code; }

      const wide = !fast || (fast && (ref.val % FALLBACK_EVERY === 0));
      if(wide){
        code=await tryZXing(img,["EAN_13","EAN_8","UPC_A","UPC_E","CODE_128","CODE_39"]);
        if(code){ show(target,`LeÃ­do (${label}/ZXing+): ${code}`,true); try{navigator.vibrate&&navigator.vibrate(25)}catch{}; return code; }
        const q=await tryQuaggaFromCanvas(canvas);
        if(q){ show(target,`LeÃ­do (${label}/Quagga): ${q}`,true); try{navigator.vibrate&&navigator.vibrate(25)}catch{}; return q; }
      }
      if(fast){ info(target,"Buscandoâ€¦ centra el cÃ³digo."); return null; }
      show(target,`No se pudo leer desde la ${label}.`,false); return null;
    }catch{ show(target,`Error procesando la ${label}.`,false); return null; }
  }

  async function pickRearDeviceId(){
    try{ const s=await navigator.mediaDevices.getUserMedia({video:true}); s.getTracks().forEach(t=>t.stop()); }catch{}
    const cams=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
    const rear=cams.find(d=>/back|rear|environment|trase|atr[aÃ¡]s|wide/i.test(d.label));
    return rear?.deviceId || cams[0]?.deviceId || null;
  }

  async function open({title="Escanear", onScan=null, continuous=false, preferFacing='environment'}={}){
    await ensureLibs(); ensureModal();

    const modalEl=qs('#barcodeModal'), titleEl=qs('#bsTitle'), video=qs('#bsVideo'),
          overlay=qs('#bsOverlay'), liveBtn=qs('#bsLive'), flipBtn=qs('#bsFlip'),
          torchBtn=qs('#bsTorch'), resBox=qs('#bsResult'), fpsEl=qs('#bsFps');

    titleEl.textContent = title;

    let deviceId=null, track=null, liveTimer=null, fpsTimer=null, decoding=false;
    const attemptRef={val:0}; let facing=preferFacing;

    function stopLive(){ if(liveTimer){ clearInterval(liveTimer); liveTimer=null; } }
    function setupTorch(){
      if(!track || !track.getCapabilities){ torchBtn.classList.add('d-none'); return; }
      torchBtn.classList.toggle('d-none', !('torch' in track.getCapabilities()));
    }
    async function ready(vid){ return new Promise(r=>{ if(vid.readyState>=2&&vid.videoWidth) return r(); const f=()=>{ if(vid.videoWidth){ vid.removeEventListener('loadedmetadata',f); r(); } }; vid.addEventListener('loadedmetadata',f); requestAnimationFrame(f); }); }
    function constraints(){
      if(deviceId) return { video:{ deviceId:{exact:deviceId}, width:{ideal:1920}, height:{ideal:1080}, focusMode:"continuous" } };
      return { video:{ facingMode:{ideal:facing}, width:{ideal:1920}, height:{ideal:1080}, focusMode:"continuous" } };
    }
    async function start(){
      stopLive(); hide(resBox);
      try{
        if(!deviceId && facing==='environment') deviceId = await pickRearDeviceId();
        const stream=await navigator.mediaDevices.getUserMedia(constraints());
        video.srcObject=stream; await video.play(); await ready(video);
        track=stream.getVideoTracks()[0]||null; overlay.style.display='';
        setupTorch();
        clearInterval(fpsTimer);
        let last=performance.now();
        fpsTimer=setInterval(()=>{ const now=performance.now(); const fps=1000/(now-last); fpsEl.textContent=isFinite(fps)?fps.toFixed(1):'0'; last=now; },1000);
      }catch(e){
        console.error(e); show(resBox,"No se pudo iniciar la cÃ¡mara. Revisa permisos o usa HTTPS.",false);
        overlay.style.display='none';
      }
    }
    function stop(){
      overlay.style.display='none';
      stopLive();
      if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; track=null; }
      torchBtn.classList.add('d-none');
      clearInterval(fpsTimer);
    }

    liveBtn.onclick = async ()=>{
      if(!video.srcObject) await start();
      await ready(video);
      if(liveTimer) return;
      attemptRef.val=0;
      liveTimer=setInterval(async ()=>{
        if(decoding) return; decoding=true;
        try{
          const dataUrl=captureROI(video);
          const code=await decodeDataURLTo(resBox,'captura',dataUrl,true,attemptRef);
          attemptRef.val++;
          if(code){
            onScan && onScan(code);
            if(!continuous){
              stopLive();
              bootstrap.Modal.getOrCreateInstance(modalEl).hide();
            }
          }
        } finally { decoding=false; }
      }, LIVE_INTERVAL_MS);
    };
    flipBtn.onclick = async ()=>{ facing = (facing==='environment') ? 'user' : 'environment'; deviceId=null; await start(); };
    torchBtn.onclick = async ()=>{ if(!track) return; const s=track.getSettings(); const on=!s.torch; try{ await track.applyConstraints({advanced:[{torch:on}]}); }catch{} };

    modalEl.addEventListener('shown.bs.modal', start, {once:true});
    modalEl.addEventListener('hidden.bs.modal', stop);
    bootstrap.Modal.getOrCreateInstance(modalEl, {backdrop:'static'}).show();
  }

  window.BarcodeScanner = { open };
})();

(function(){
  // abrir scanner y autocompletar SKU
  const form  = document.getElementById('searchForm');
  const input = document.getElementById('skuInput');
  const btn   = document.getElementById('btnOpenScanner');
  const btnSubmit = document.getElementById('btnSubmit');

  form.addEventListener('submit', () => {
    if (btnSubmit.dataset.loading) return;
    btnSubmit.dataset.loading = "1";
    btnSubmit.disabled = true;
    const old = btnSubmit.textContent;
    btnSubmit.dataset.old = old;
    btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Buscandoâ€¦';
    setTimeout(()=>{ btnSubmit.disabled = false; btnSubmit.textContent = old; btnSubmit.removeAttribute('data-loading'); }, 3000);
  });

  btn.addEventListener('click', () => {
    if (!window.BarcodeScanner) { alert('EscÃ¡ner no cargado.'); return; }
    BarcodeScanner.open({
      title: 'Escanear SKU',
      continuous: false,
      preferFacing: 'environment',
      onScan: (code) => {
        input.value = code;
        input.blur();
        setTimeout(() => form.requestSubmit(), 0);
      }
    });
  });

  const btnCopy = document.getElementById('copySku');
  if (btnCopy){
    btnCopy.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText('{{ producto.sku|default_if_none:"" }}');
        btnCopy.classList.remove('btn-outline-secondary');
        btnCopy.classList.add('btn-success'); btnCopy.textContent = 'SKU copiado';
        setTimeout(()=>{
          btnCopy.classList.remove('btn-success');
          btnCopy.classList.add('btn-outline-secondary');
          btnCopy.textContent='Copiar SKU';
        }, 1400);
      }catch(e){ console.warn(e); }
    });
  }
})();
</script>
{% endblock %}
