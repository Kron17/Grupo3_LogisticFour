{% extends "core/base.html" %}
{% block title %}Formulario Sucursal{% endblock %}

{% block content %}
<style>
  :root{
    --ink:#0f172a;
    --muted:#6b7280;
    --line:#e5e7eb;
    --card:#ffffff;
    --bg-soft:#f3f4f6;
    --accent:#111827;
    --accent-soft:#eef2ff;
    --ok:#16a34a;
    --danger:#dc2626;
  }

  body{
    background:radial-gradient(circle at top,#e5edff 0,#f9fafb 55%,#e5e7eb 100%);
  }

  .s-shell{
    max-width:960px;
    margin-inline:auto;
    padding:18px 12px 26px;
    display:grid;
    gap:14px;
    animation:sFadeIn .35s ease-out;
  }

  @keyframes sFadeIn{
    from{opacity:0;transform:translateY(8px);}
    to{opacity:1;transform:translateY(0);}
  }

  /* ===== MIGAS DE PAN ===== */
  .breadcrumb{
    font-size:.8rem;
    color:var(--muted);
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    align-items:center;
  }
  .breadcrumb a{
    color:inherit;
    text-decoration:none;
  }
  .breadcrumb a:hover{
    text-decoration:underline;
  }
  .breadcrumb span.sep{
    opacity:.6;
  }

  /* ===== CARD FORM ===== */
  .form-shell{
    background:var(--card);
    border-radius:18px;
    border:1px solid rgba(226,232,240,.95);
    box-shadow:0 16px 40px rgba(15,23,42,.08);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    max-height:calc(100vh - 120px);
  }

  /* HEADER */
  .form-head{
    padding:14px 16px 12px;
    background:linear-gradient(120deg,#0f172a,#111827 55%,#1f2937);
    color:#e5e7eb;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:flex-start;
  }
  .form-head-main{
    display:grid;
    gap:4px;
  }
  .form-head-title{
    margin:0;
    font-weight:800;
    letter-spacing:.03em;
    font-size:clamp(1.1rem,2.2vw,1.4rem);
    display:flex;
    align-items:center;
    gap:.55rem;
  }
  .form-head-pill{
    font-size:.68rem;
    padding:3px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.7);
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .form-head-sub{
    margin:0;
    font-size:.85rem;
    color:#cbd5f5;
    max-width:520px;
  }

  .form-head-meta{
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:flex-end;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 9px;
    font-size:.72rem;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.5);
    color:#e5e7eb;
    backdrop-filter:blur(4px);
  }
  .badge-dot{
    width:7px;
    height:7px;
    border-radius:999px;
    background:#22c55e;
  }
  .badge-dot.off{ background:#f97316; }

  .pill-id{
    font-size:.72rem;
    color:#cbd5f5;
    background:rgba(15,23,42,.4);
    border-radius:999px;
    padding:3px 7px;
  }

  /* BODY SCROLLABLE */
  .form-body{
    padding:14px 16px 70px; /* dejamos espacio para las acciones sticky */
    display:grid;
    gap:16px;
    overflow:auto;
  }

  .form-section-title{
    font-size:.82rem;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--muted);
    margin:0 0 2px;
  }
  .form-section-sub{
    margin:0;
    font-size:.8rem;
    color:#9ca3af;
  }

  .form-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:14px;
    margin-top:8px;
  }
  @media (max-width:760px){
    .form-shell{
      max-height:none;
    }
    .form-body{
      padding:12px 12px 72px;
    }
    .form-grid{
      grid-template-columns:1fr;
    }
    .form-head{
      flex-direction:column;
      align-items:flex-start;
    }
    .form-head-meta{
      align-items:flex-start;
    }
  }

  /* CAMPOS */
  .field{
    display:grid;
    gap:5px;
    animation: fieldFade .35s ease both;
  }
  @keyframes fieldFade{
    from{opacity:0;transform:translateY(4px);}
    to{opacity:1;transform:none;}
  }

  .field label{
    font-size:.78rem;
    font-weight:600;
    color:var(--ink);
    display:flex;
    justify-content:space-between;
    gap:6px;
    align-items:center;
  }

  .label-pill{
    font-size:.68rem;
    padding:1px 6px 2px;
    border-radius:999px;
    background:#f3f4ff;
    color:#4f46e5;
    border:1px solid #e0e7ff;
  }

  .field .help{
    font-size:.75rem;
    color:#9ca3af;
  }
  .field .err{
    font-size:.75rem;
    color:var(--danger);
  }

  .field input[type="text"]{
    padding:9px 11px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#f9fafb;
    font-size:.88rem;
    transition:border .18s ease,box-shadow .18s ease,background .18s ease,transform .09s ease;
  }
  .field input[type="text"]:focus{
    outline:none;
    border-color:var(--accent);
    background:#ffffff;
    box-shadow:0 0 0 2px rgba(15,23,42,.15);
    transform:translateY(-1px);
  }
  .field.invalid input[type="text"]{
    border-color:#ef4444;
    background:#fef2f2;
  }

  /* SWITCH ACTIVO */
  .switch{
    border-radius:14px;
    border:1px dashed var(--line);
    background:#f9fafb;
    padding:10px 12px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .switch label{
    margin:0;
    font-weight:600;
    font-size:.85rem;
    color:var(--ink);
  }
  .switch .hint{
    font-size:.8rem;
    color:var(--muted);
  }

  /* CONTADOR C√ìDIGO */
  .counter{
    font-size:.74rem;
    color:#9ca3af;
    justify-self:flex-end;
  }
  .counter.too-long{
    color:var(--danger);
    font-weight:600;
  }

  /* ACCIONES STICKY */
  .form-actions{
    position:sticky;
    bottom:0;
    padding:9px 12px;
    border-top:1px solid rgba(226,232,240,.96);
    background:rgba(248,250,252,.94);
    backdrop-filter:blur(6px);
    display:flex;
    justify-content:flex-end;
    gap:10px;
  }

  .btnx{
    display:inline-flex;
    align-items:center;
    gap:7px;
    padding:8.5px 14px;
    border-radius:999px;
    border:1px solid transparent;
    cursor:pointer;
    font-size:.85rem;
    font-weight:600;
    text-decoration:none;
    transition:background .16s ease,box-shadow .16s ease,transform .09s ease,border-color .16s ease;
  }
  .btnx.primary{
    background:var(--accent);
    color:#ffffff;
    box-shadow:0 10px 25px rgba(15,23,42,.24);
  }
  .btnx.primary:hover{
    background:#000000;
    transform:translateY(-1px);
    box-shadow:0 14px 34px rgba(15,23,42,.33);
  }
  .btnx.ghost{
    background:#ffffff;
    color:var(--ink);
    border-color:var(--line);
  }
  .btnx.ghost:hover{
    background:#f9fafb;
    transform:translateY(-1px);
  }
  .btnx:disabled{
    opacity:.6;
    cursor:not-allowed;
    box-shadow:none;
  }

  .btn-icon{
    font-size:1rem;
  }
</style>

<div class="s-shell">

  <!-- Migas de pan -->
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <a href="{% url 'dashboard' %}">Inicio</a>
    <span class="sep">/</span>
    <a href="{% url 'sucursal-list' %}">Sucursales</a>
    <span class="sep">/</span>
    <span>{% if object %}Editar{% else %}Crear{% endif %}</span>
  </nav>

  <div class="form-shell">
    <!-- HEADER -->
    <header class="form-head">
      <div class="form-head-main">
        <h1 class="form-head-title">
          <span>{% if object %}Editar sucursal{% else %}Crear sucursal{% endif %}</span>
          <span class="form-head-pill">Sucursal</span>
        </h1>
        <p class="form-head-sub">
          Completa los datos b√°sicos de la sucursal. El c√≥digo se usa para identificarla en
          reportes, movimientos y b√∫squedas internas.
        </p>
      </div>

      <div class="form-head-meta">
        {% if object %}
          <span class="badge">
            <span class="badge-dot {% if not object.activo %}off{% endif %}"></span>
            {% if object.activo %}Activa{% else %}Inactiva{% endif %}
          </span>
          <span class="pill-id">ID: {{ object.id }}</span>
        {% else %}
          <span class="badge">
            <span class="badge-dot"></span>
            Nueva sucursal
          </span>
        {% endif %}
      </div>
    </header>

    <form method="post" novalidate>
      {% csrf_token %}

      <!-- Errores generales -->
      {% if form.non_field_errors %}
        <div class="form-body">
          <div class="field invalid">
            <div class="err">{{ form.non_field_errors }}</div>
          </div>
        </div>
      {% endif %}

      <div class="form-body">

        <!-- Bloque datos b√°sicos -->
        <div>
          <p class="form-section-title">Datos b√°sicos</p>
          <p class="form-section-sub">
            C√≥digo, nombre y direcci√≥n se usar√°n en documentos y listados.
          </p>

          <div class="form-grid">
            <!-- C√≥digo -->
            <div class="field {% if form.codigo.errors %}invalid{% endif %}">
              <label for="{{ form.codigo.id_for_label }}">
                <span>C√≥digo</span>
                <span class="label-pill">m√°x. 20 caracteres</span>
              </label>
              {{ form.codigo }}
              {% if form.codigo.help_text %}
                <div class="help">{{ form.codigo.help_text }}</div>
              {% endif %}
              <div class="counter" id="codigoCounter">0/20</div>
              {% for e in form.codigo.errors %}
                <div class="err">{{ e }}</div>
              {% endfor %}
            </div>

            <!-- Nombre -->
            <div class="field {% if form.nombre.errors %}invalid{% endif %}">
              <label for="{{ form.nombre.id_for_label }}">Nombre</label>
              {{ form.nombre }}
              {% for e in form.nombre.errors %}
                <div class="err">{{ e }}</div>
              {% endfor %}
            </div>

            <!-- Direcci√≥n -->
            <div class="field {% if form.direccion.errors %}invalid{% endif %}">
              <label for="{{ form.direccion.id_for_label }}">Direcci√≥n</label>
              {{ form.direccion }}
              {% for e in form.direccion.errors %}
                <div class="err">{{ e }}</div>
              {% endfor %}
            </div>

            <!-- Ciudad -->
            <div class="field {% if form.ciudad.errors %}invalid{% endif %}">
              <label for="{{ form.ciudad.id_for_label }}">Ciudad</label>
              {{ form.ciudad }}
              {% for e in form.ciudad.errors %}
                <div class="err">{{ e }}</div>
              {% endfor %}
            </div>

            <!-- Regi√≥n -->
            <div class="field {% if form.region.errors %}invalid{% endif %}">
              <label for="{{ form.region.id_for_label }}">Regi√≥n / Estado</label>
              {{ form.region }}
              {% for e in form.region.errors %}
                <div class="err">{{ e }}</div>
              {% endfor %}
            </div>

            <!-- Pa√≠s -->
            <div class="field {% if form.pais.errors %}invalid{% endif %}">
              <label for="{{ form.pais.id_for_label }}">Pa√≠s</label>
              {{ form.pais }}
              {% for e in form.pais.errors %}
                <div class="err">{{ e }}</div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Bloque estado -->
        <div>
          <p class="form-section-title">Estado operativo</p>
          <p class="form-section-sub">
            Controla si la sucursal puede usarse para movimientos de stock y operaciones.
          </p>

          <div class="switch">
            {{ form.activo }}
            <label for="{{ form.activo.id_for_label }}">
              Sucursal activa
            </label>
            <span class="hint">
              Cuando est√° inactiva no podr√° ser seleccionada en movimientos ni gu√≠as.
            </span>
          </div>
        </div>

      </div>

      <!-- ACCIONES -->
      <div class="form-actions">
        <a class="btnx ghost" href="{% url 'sucursal-list' %}">
          <span class="btn-icon">‚Üê</span>
          <span>Cancelar</span>
        </a>
        <button class="btnx primary" type="submit">
          <span class="btn-icon">üíæ</span>
          <span>Guardar</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
/* May√∫sculas y contador para C√≥digo */
(function(){
  const input   = document.getElementById('{{ form.codigo.id_for_label }}');
  const counter = document.getElementById('codigoCounter');
  if (!input || !counter) return;

  const max = parseInt(input.getAttribute('maxlength') || '20', 10);

  const update = () => {
    const caret = input.selectionStart;
    const val   = (input.value || "").toUpperCase();
    if (val !== input.value){
      input.value = val;
      try{ input.setSelectionRange(caret, caret); }catch(e){}
    }
    const len = input.value.length;
    counter.textContent = `${len}/${max}`;
    counter.classList.toggle('too-long', len > max);
  };

  input.addEventListener('input', update);
  update();
})();
</script>

{% endblock %}
